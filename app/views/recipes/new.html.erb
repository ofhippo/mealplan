<%= form_for @recipe do |f| %>
  <%= f.label :name %>
  <%= f.text_field :name %>
  <br/>
  <%= f.label :text %>
  <%= f.text_area :text %>
  <br/>
  <% 10.times do |i| %>
    <%= fields_for "recipe_ingredients[#{i}]" do |ingredient_fields| %>
      <%= ingredient_fields.label :quantity %>
      <%= ingredient_fields.text_field :quantity %>
      <%= ingredient_fields.label :name %>
      <%= ingredient_fields.hidden_field(:ingredient_id, :class => 'ingredient-input') %>
      <br/>
    <% end %>
  <% end %>

  <%= f.submit %>
<% end %>

<script>
  $(".ingredient-input").select2({
    placeholder: "Find or add ingredient",
    createSearchChoice: function(term, data){
      return { id: "NEWINGREDIENT[" + term + "]", text: term };
    },
  data: <%= ("[" + Ingredient.all.map{|i| "{id: #{i.id}, text: '#{i.name}'}"}.join(",") + "]").html_safe %>
  });
</script>
